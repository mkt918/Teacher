// ===== 蟶ｭ譖ｿ縺医ヤ繝ｼ繝ｫ繝｢繧ｸ繝･繝ｼ繝ｫ =====

const SeatingModule = {
    currentLayout: null,
    rows: 6,
    cols: 7,
    history: [],
    draggedStudent: null,
    isLotteryMode: false,

    // 繝医Λ繝ｳ繝怜ｮ夂ｾｩ
    suits: [
        { id: 'spade', symbol: '笙', color: 'black', label: '繧ｹ繝壹・繝・ },
        { id: 'club', symbol: '笙｣', color: 'black', label: '繧ｯ繝ｩ繝・ },
        { id: 'heart', symbol: '笙･', color: 'red', label: '繝上・繝・ },
        { id: 'diamond', symbol: '笙ｦ', color: 'red', label: '繝繧､繝､' }
    ],

    // 繧ｫ繝ｼ繝芽ｨｭ螳・
    cardsPerSuit: 10,

    // 蛻晄悄蛹・
    init() {
        if (this.initialized) return;
        this.setupEventListeners();
        this.initialized = true;
        console.log('ｪ・Seating Module initialized');
    },

    // 縺上§蠑輔″繧ｫ繝ｼ繝峨・繧ｷ繝｣繝・ヵ繝ｫ驟咲ｽｮ
    shuffleCards() {
        // 迴ｾ蝨ｨ縺ｮ繝・・繧ｿ蜿門ｾ・
        const data = StorageManager.getCurrentData();
        const lockedSeats = data.seating.lockedSeats || []; // {row, col, studentId}

        // 菴ｿ逕ｨ縺吶ｋ繧ｫ繝ｼ繝峨ｒ逕滓・・郁ｨｭ螳壽椢謨ｰ蛻・ｼ・
        const deck = [];
        const maxNum = this.cardsPerSuit || 10;

        this.suits.forEach(suit => {
            for (let i = 1; i <= maxNum; i++) {
                deck.push({ suit: suit.id, number: i });
            }
        });

        // 繧ｫ繝ｼ繝峨ｒ繧ｷ繝｣繝・ヵ繝ｫ
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }

        // 蠎ｧ蟶ｭ縺ｫ蜑ｲ繧雁ｽ薙※
        const cards = {};
        let cardIndex = 0;

        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                // 繝ｭ繝・け縺輔ｌ縺ｦ縺・ｋ蠎ｧ蟶ｭ縺ｯ繧ｹ繧ｭ繝・・
                const isLocked = lockedSeats.some(s => s.row === r && s.col === c);
                if (isLocked) continue;

                if (cardIndex < deck.length) {
                    cards[`${r}-${c}`] = deck[cardIndex];
                    cardIndex++;
                }
            }
        }

        // 菫晏ｭ・
        if (!data.seating) data.seating = {};
        data.seating.cards = cards;
        StorageManager.updateCurrentData(data);
        this.render();
    },

    // 繧ｫ繝ｼ繝画椢謨ｰ險ｭ螳壹・螟画峩
    setCardsPerSuit(num) {
        this.cardsPerSuit = parseInt(num) || 10;
        // 險ｭ螳壹ｒ菫晏ｭ倥☆繧九Ο繧ｸ繝・け縺悟ｿ・ｦ√↑繧峨％縺薙↓霑ｽ蜉・育樟迥ｶ縺ｯ繧ｪ繝ｳ繝｡繝｢繝ｪ・・
        this.shuffleCards();
    },

    // 繧､繝吶Φ繝医Μ繧ｹ繝翫・縺ｮ繧ｻ繝・ヨ繧｢繝・・
    setupEventListeners() {
        // 陦後・蛻励・螟画峩
        const rowsInput = document.getElementById('seatingRows');
        const colsInput = document.getElementById('seatingCols');

        if (rowsInput) {
            rowsInput.addEventListener('change', (e) => {
                this.rows = parseInt(e.target.value) || 6;
                this.render();
            });
        }

        if (colsInput) {
            colsInput.addEventListener('change', (e) => {
                this.cols = parseInt(e.target.value) || 6;
                this.render();
            });
        }

        // 繝ｩ繝ｳ繝繝驟咲ｽｮ繝懊ち繝ｳ
        const randomBtn = document.getElementById('randomSeatingBtn');
        if (randomBtn) {
            randomBtn.addEventListener('click', () => {
                this.randomArrange();
            });
        }

        // 繧ｯ繝ｪ繧｢繝懊ち繝ｳ
        const clearBtn = document.getElementById('clearSeatingBtn');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                this.clearSeating();
            });
        }

        // 菫晏ｭ倥・繧ｿ繝ｳ
        const saveBtn = document.getElementById('saveSeatingBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                this.saveToHistory();
            });
        }

        // 螻･豁ｴ繝懊ち繝ｳ
        const historyBtn = document.getElementById('seatingHistoryBtn');
        if (historyBtn) {
            historyBtn.addEventListener('click', () => {
                this.showHistory();
            });
        }

        // 蜊ｰ蛻ｷ繝懊ち繝ｳ
        const printBtn = document.getElementById('printSeatingBtn');
        if (printBtn) {
            printBtn.addEventListener('click', () => {
                this.printSeating();
            });
        }

        // 縺上§蠑輔″繝｢繝ｼ繝牙・繧頑崛縺・
        const toggleLotteryBtn = document.getElementById('toggleLotteryBtn');
        if (toggleLotteryBtn) {
            toggleLotteryBtn.addEventListener('click', () => {
                this.toggleLotteryMode();
            });
        }

        // 繧ｫ繝ｼ繝牙・驟咲ｽｮ
        const shuffleCardsBtn = document.getElementById('shuffleCardsBtn');
        if (shuffleCardsBtn) {
            shuffleCardsBtn.addEventListener('click', () => {
                this.shuffleCards();
            });
        }

        // 譛ｪ驟咲ｽｮ繝ｪ繧ｹ繝医∈縺ｮ繝峨Ο繝・・・磯・鄂ｮ隗｣髯､・・
        const unassignedContainer = document.getElementById('unassignedStudents');
        if (unassignedContainer) {
            unassignedContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                unassignedContainer.classList.add('drag-over');
            });
            unassignedContainer.addEventListener('dragleave', () => {
                unassignedContainer.classList.remove('drag-over');
            });
            unassignedContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                unassignedContainer.classList.remove('drag-over');
                this.onDropToUnassigned(e);
            });
        }

        // 邨先棡蜈･蜉・
        const inputLotteryResultBtn = document.getElementById('inputLotteryResultBtn');
        if (inputLotteryResultBtn) {
            inputLotteryResultBtn.addEventListener('click', () => {
                this.openLotteryInputModal();
            });
        }

        // 邨先棡蜿肴丐
        const reflectLotteryResultBtn = document.getElementById('reflectLotteryResultBtn');
        if (reflectLotteryResultBtn) {
            reflectLotteryResultBtn.addEventListener('click', () => {
                this.reflectLotteryResults();
            });
        }

        // 繝｢繝ｼ繝繝ｫ繧ｭ繝｣繝ｳ繧ｻ繝ｫ
        const cancelLotteryInputBtn = document.getElementById('cancelLotteryInputBtn');
        if (cancelLotteryInputBtn) {
            cancelLotteryInputBtn.addEventListener('click', () => {
                document.getElementById('lotteryInputModal').classList.remove('active');
            });
        }

        const closeLotteryInputModal = document.getElementById('closeLotteryInputModal');
        if (closeLotteryInputModal) {
            closeLotteryInputModal.addEventListener('click', () => {
                document.getElementById('lotteryInputModal').classList.remove('active');
            });
        }
    },

    // 謠冗判
    render() {
        const data = StorageManager.getCurrentData();

        // 迴ｾ蝨ｨ縺ｮ繝ｬ繧､繧｢繧ｦ繝医ｒ蜿門ｾ励∪縺溘・蛻晄悄蛹・
        if (!this.currentLayout) {
            this.currentLayout = data.seating.current || this.createEmptyLayout();
        }

        // 蠎ｧ蟶ｭ陦ｨ繧呈緒逕ｻ
        if (this.isLotteryMode) {
            this.renderLotteryGrid();
            document.getElementById('lotteryControls').style.display = 'flex';
        } else {
            this.renderSeatingGrid();
            document.getElementById('lotteryControls').style.display = 'none';
        }

        // 譛ｪ驟咲ｽｮ逕溷ｾ偵Μ繧ｹ繝医ｒ謠冗判 (縺上§蠑輔″繝｢繝ｼ繝画凾縺ｯ髱櫁｡ｨ遉ｺ謗ｨ螂ｨ縺縺御ｸ譌ｦ縺昴・縺ｾ縺ｾ)
        this.renderUnassignedStudents();

        // 險ｭ螳壼､繧貞渚譏
        const rowsInput = document.getElementById('seatingRows');
        const colsInput = document.getElementById('seatingCols');
        if (rowsInput) rowsInput.value = this.rows;
        if (colsInput) colsInput.value = this.cols;
    },

    // 遨ｺ縺ｮ繝ｬ繧､繧｢繧ｦ繝医ｒ菴懈・
    createEmptyLayout() {
        const layout = [];
        for (let r = 0; r < this.rows; r++) {
            const row = [];
            for (let c = 0; c < this.cols; c++) {
                row.push(null);
            }
            layout.push(row);
        }
        return layout;
    },

    // 蠎ｧ蟶ｭ陦ｨ繧ｰ繝ｪ繝・ラ繧呈緒逕ｻ
    renderSeatingGrid() {
        const container = document.getElementById('seatingGrid');
        if (!container) return;

        const data = StorageManager.getCurrentData();

        container.innerHTML = '';
        container.style.gridTemplateColumns = `repeat(${this.cols}, 1fr)`;

        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.dataset.row = r;
                seat.dataset.col = c;

                const studentId = this.currentLayout[r] && this.currentLayout[r][c];
                const lockedSeats = data.seating.lockedSeats || [];
                const isLocked = lockedSeats.some(s => s.row === r && s.col === c);

                if (isLocked) seat.classList.add('locked');

                // 繝ｭ繝・け繝懊ち繝ｳ・磯嵯繧｢繧､繧ｳ繝ｳ・・
                const lockBtn = document.createElement('button');
                lockBtn.className = `seat-lock-btn ${isLocked ? 'active' : ''}`;
                lockBtn.innerHTML = isLocked ? '白' : '箔';
                lockBtn.title = isLocked ? '繝ｭ繝・け隗｣髯､' : '繝ｭ繝・け縺吶ｋ';
                lockBtn.onclick = (e) => {
                    e.stopPropagation();
                    this.toggleLock(r, c);
                };
                seat.appendChild(lockBtn);

                if (studentId) {
                    const student = data.students.find(s => s.id === studentId);
                    if (student) {
                        seat.classList.add('occupied');

                        // 逕溷ｾ呈ュ蝣ｱ繧奪OM隕∫ｴ縺ｨ縺励※菴懈・
                        const studentDiv = document.createElement('div');
                        studentDiv.className = 'seat-student';
                        studentDiv.draggable = !isLocked;
                        studentDiv.dataset.studentId = studentId;

                        const numberDiv = document.createElement('div');
                        numberDiv.className = 'seat-number';
                        numberDiv.textContent = student.number;

                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'seat-name';
                        nameDiv.textContent = student.nameKanji;

                        studentDiv.appendChild(numberDiv);
                        studentDiv.appendChild(nameDiv);
                        seat.appendChild(studentDiv);

                        // 繝峨Λ繝・げ繧､繝吶Φ繝・(繝ｭ繝・け縺輔ｌ縺ｦ縺・↑縺・ｴ蜷医・縺ｿ)
                        if (!isLocked) {
                            studentDiv.addEventListener('dragstart', (e) => {
                                this.onDragStart(e, studentId, r, c);
                            });
                        }
                    }
                } else {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'seat-empty';
                    emptyDiv.innerText = '遨ｺ蟶ｭ';
                    seat.appendChild(emptyDiv);
                }

                // 繝峨Ο繝・・繧､繝吶Φ繝・(繝ｭ繝・け縺輔ｌ縺ｦ縺・↑縺・ｴ蜷医・縺ｿ)
                if (!isLocked) {
                    seat.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        seat.classList.add('drag-over');
                    });

                    seat.addEventListener('dragleave', () => {
                        seat.classList.remove('drag-over');
                    });

                    seat.addEventListener('drop', (e) => {
                        e.preventDefault();
                        seat.classList.remove('drag-over');
                        this.onDrop(e, r, c);
                    });
                }

                container.appendChild(seat);
            }
        }

        // 謨吝酷繧定｡ｨ遉ｺ
        this.renderTeacherDesk();
    }
    ,

    // 謨吝酷繧偵Ξ繝ｳ繝繝ｪ繝ｳ繧ｰ
    renderTeacherDesk() {
        const container = document.getElementById('seatingGrid');
        if (!container) return;

        // 譌｢蟄倥・謨吝酷縺後≠繧後・蜑企勁
        const oldDesk = document.getElementById('teacherDesk');
        if (oldDesk) oldDesk.remove();

        const desk = document.createElement('div');
        desk.id = 'teacherDesk';
        desk.className = 'teacher-desk';
        desk.innerText = '謨吝酷';

        // 繧ｰ繝ｪ繝・ラ縺ｮ繧ｹ繧ｿ繧､繝ｫ繧貞叙蠕励＠縺ｦ謨吝酷縺ｮ菴咲ｽｮ繧定ｪｿ謨ｴ
        // 謨吝酷縺ｯ繧ｰ繝ｪ繝・ラ縺ｮ荳九↓驟咲ｽｮ縺吶ｋ縺溘ａ縲∬ｦｪ隕∫ｴ縺ｫ霑ｽ蜉縺吶ｋ縺九√げ繝ｪ繝・ラ蜀・・迚ｹ蛻･縺ｪ陦後→縺励※謇ｱ縺・
        // 縺薙％縺ｧ縺ｯ繧ｰ繝ｪ繝・ラ縺ｮ荳九↓驟咲ｽｮ縺吶ｋ縺溘ａ縺ｫ隕ｪ隕∫ｴ縺ｮ譛ｫ蟆ｾ縺ｫ霑ｽ蜉
        container.parentNode.appendChild(desk);
    },

    // 繝ｭ繝・け縺ｮ蛻・ｊ譖ｿ縺・
    toggleLock(row, col) {
        const data = StorageManager.getCurrentData();
        if (!data.seating.lockedSeats) data.seating.lockedSeats = [];

        const index = data.seating.lockedSeats.findIndex(s => s.row === row && s.col === col);
        if (index > -1) {
            data.seating.lockedSeats.splice(index, 1);
        } else {
            data.seating.lockedSeats.push({ row, col });
        }

        StorageManager.updateCurrentData(data);
        this.render();
    },

    // 譛ｪ驟咲ｽｮ逕溷ｾ偵Μ繧ｹ繝医ｒ謠冗判
    renderUnassignedStudents() {
        const container = document.getElementById('unassignedStudents');
        if (!container) return;

        const data = StorageManager.getCurrentData();

        // 驟咲ｽｮ貂医∩縺ｮ逕溷ｾ棚D繧貞庶髮・
        const assignedIds = new Set();
        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                const studentId = this.currentLayout[r] && this.currentLayout[r][c];
                if (studentId) {
                    assignedIds.add(studentId);
                }
            }
        }

        // 譛ｪ驟咲ｽｮ縺ｮ逕溷ｾ偵ｒ謚ｽ蜃ｺ
        const unassigned = data.students.filter(s => !assignedIds.has(s.id));

        if (unassigned.length === 0) {
            container.innerHTML = '<div class="empty-state-small"><p>蜈ｨ蜩｡驟咲ｽｮ貂医∩</p></div>';
            return;
        }

        container.innerHTML = unassigned.map(student => `
            <div class="unassigned-student" draggable="true" data-student-id="${student.id}">
                <div class="student-number">${student.number}</div>
                <div class="student-name">
                    <div class="name-kanji">${student.nameKanji}</div>
                    <div class="name-kana">${student.nameKana}</div>
                </div>
            </div>
        `).join('');

        // 繝峨Λ繝・げ繧､繝吶Φ繝・
        container.querySelectorAll('.unassigned-student').forEach(el => {
            el.addEventListener('dragstart', (e) => {
                const studentId = el.dataset.studentId;
                this.onDragStart(e, studentId, null, null);
            });
        });
    },

    // 繝峨Λ繝・げ髢句ｧ・
    onDragStart(e, studentId, row, col) {
        this.draggedStudent = {
            id: studentId,
            fromRow: row,
            fromCol: col
        };
        e.dataTransfer.effectAllowed = 'move';
        e.target.style.opacity = '0.5';
    },

    // 繝峨Ο繝・・
    onDrop(e, toRow, toCol) {
        if (!this.draggedStudent) return;

        const { id, fromRow, fromCol } = this.draggedStudent;

        // 蜈・・菴咲ｽｮ縺九ｉ蜑企勁・亥ｺｧ蟶ｭ縺九ｉ縺ｮ遘ｻ蜍輔・蝣ｴ蜷茨ｼ・
        if (fromRow !== null && fromCol !== null) {
            this.currentLayout[fromRow][fromCol] = null;
        }

        // 譁ｰ縺励＞菴咲ｽｮ縺ｫ驟咲ｽｮ・域里蟄倥・逕溷ｾ偵′縺・ｌ縺ｰ蜈･繧梧崛縺茨ｼ・
        const existingStudent = this.currentLayout[toRow][toCol];
        this.currentLayout[toRow][toCol] = id;

        // 蜈･繧梧崛縺医・蝣ｴ蜷医∝・縺ｮ菴咲ｽｮ縺ｫ遘ｻ蜍・
        if (existingStudent && fromRow !== null && fromCol !== null) {
            this.currentLayout[fromRow][fromCol] = existingStudent;
        }

        // 繝・・繧ｿ繧剃ｿ晏ｭ・
        this.saveCurrentLayout();

        // 蜀肴緒逕ｻ
        this.render();

        this.draggedStudent = null;
    },

    // 譛ｪ驟咲ｽｮ繝ｪ繧ｹ繝医∈繝峨Ο繝・・・亥ｺｧ蟶ｭ縺九ｉ縺ｮ驟咲ｽｮ隗｣髯､・・
    onDropToUnassigned(e) {
        if (!this.draggedStudent) return;

        const { fromRow, fromCol } = this.draggedStudent;

        // 蠎ｧ蟶ｭ縺九ｉ縺ｮ遘ｻ蜍輔・縺ｿ蜃ｦ逅・
        if (fromRow !== null && fromCol !== null) {
            this.currentLayout[fromRow][fromCol] = null;
            this.saveCurrentLayout();
            this.render();
        }

        this.draggedStudent = null;
    },

    // 繝ｩ繝ｳ繝繝驟咲ｽｮ
    randomArrange() {
        if (!confirm('繝ｭ繝・け縺輔ｌ縺ｦ縺・↑縺・ｺｧ蟶ｭ繧偵Λ繝ｳ繝繝縺ｫ蜈･繧梧崛縺医∪縺吶°・・)) {
            return;
        }

        const data = StorageManager.getCurrentData();
        const lockedSeats = data.seating.lockedSeats || [];

        // 繝ｭ繝・け縺輔ｌ縺ｦ縺・↑縺・ｺｧ蟶ｭ縺ｮ菴咲ｽｮ縺ｨ縲√◎縺薙↓縺・ｋ逕溷ｾ抵ｼ医∪縺溘・遨ｺ蟶ｭ・峨ｒ蜿朱寔
        const availablePositions = [];
        const studentsToShuffle = [];

        // 縺吶∋縺ｦ縺ｮ逕溷ｾ偵ｒ蜿門ｾ・
        const allStudents = [...data.students];
        const lockedStudentIds = new Set();

        // 繝ｭ繝・け縺輔ｌ縺ｦ縺・ｋ蠎ｧ蟶ｭ縺ｮ逕溷ｾ偵ｒ迚ｹ螳・
        lockedSeats.forEach(ls => {
            const sid = this.currentLayout[ls.row] && this.currentLayout[ls.row][ls.col];
            if (sid) lockedStudentIds.add(sid);
        });

        // 繧ｷ繝｣繝・ヵ繝ｫ蟇ｾ雎｡縺ｮ逕溷ｾ抵ｼ医Ο繝・け縺輔ｌ縺ｦ縺・↑縺・函蠕抵ｼ・
        const unassignedStudentsWithIds = allStudents.filter(s => !lockedStudentIds.has(s.id));

        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                const isLocked = lockedSeats.some(ls => ls.row === r && ls.col === c);
                if (!isLocked) {
                    availablePositions.push({ r, c });
                }
            }
        }

        // 逕溷ｾ偵ｒ繧ｷ繝｣繝・ヵ繝ｫ
        for (let i = unassignedStudentsWithIds.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [unassignedStudentsWithIds[i], unassignedStudentsWithIds[j]] = [unassignedStudentsWithIds[j], unassignedStudentsWithIds[i]];
        }

        // 譁ｰ縺励＞繝ｬ繧､繧｢繧ｦ繝医↓蜿肴丐・磯撼繝ｭ繝・け邂・園縺ｮ縺ｿ譖ｴ譁ｰ・・
        let studentIndex = 0;
        availablePositions.forEach(pos => {
            if (studentIndex < unassignedStudentsWithIds.length) {
                this.currentLayout[pos.r][pos.c] = unassignedStudentsWithIds[studentIndex].id;
                studentIndex++;
            } else {
                this.currentLayout[pos.r][pos.c] = null; // 逕溷ｾ偵′雜ｳ繧翫↑縺・ｴ蜷医・遨ｺ蟶ｭ
            }
        });

        this.saveCurrentLayout();
        this.render();
    },

    // 逡ｪ蜿ｷ鬆・↓荳ｦ縺ｹ繧具ｼ亥承蜑阪°繧牙ｾ後ｍ縺ｸ・・
    arrangeByNumber() {
        if (!confirm('逡ｪ蜿ｷ鬆・↓荳ｦ縺ｹ譖ｿ縺医∪縺吶°・歃\n・域蕗蜊灘・・井ｸ具ｼ峨ｒ蜑阪→縺励※縲∝承蜑阪°繧蛾・鄂ｮ縺輔ｌ縺ｾ縺呻ｼ・)) {
            return;
        }

        const data = StorageManager.getCurrentData();
        const lockedSeats = data.seating.lockedSeats || [];

        // 繝ｭ繝・け縺輔ｌ縺ｦ縺・ｋ蠎ｧ蟶ｭ縺ｮ逕溷ｾ偵ｒ迚ｹ螳・
        const lockedStudentIds = new Set();
        lockedSeats.forEach(ls => {
            const sid = this.currentLayout[ls.row] && this.currentLayout[ls.row][ls.col];
            if (sid) lockedStudentIds.add(sid);
        });

        // 繝ｭ繝・け縺輔ｌ縺ｦ縺・↑縺・函蠕偵ｒ逡ｪ蜿ｷ鬆・↓繧ｽ繝ｼ繝・
        const studentsToArrange = data.students
            .filter(s => !lockedStudentIds.has(s.id))
            .sort((a, b) => a.number.localeCompare(b.number, 'ja', { numeric: true }));

        // 繝ｭ繝・け縺輔ｌ縺ｦ縺・↑縺・ｺｧ蟶ｭ繧呈蕗蜊灘・・井ｸ具ｼ峨ｒ蜑阪→縺励※蜿ｳ蜑阪°繧蛾・↓蜿朱寔
        // 蛻鈴・ｼ亥承縺九ｉ蟾ｦ・峨∝推蛻怜・縺ｧ陦碁・ｼ井ｸ九°繧我ｸ奇ｼ晄蕗蜊灘・縺悟燕・・
        const availablePositions = [];
        for (let c = this.cols - 1; c >= 0; c--) { // 蜿ｳ縺九ｉ蟾ｦ
            for (let r = this.rows - 1; r >= 0; r--) { // 荳九°繧我ｸ奇ｼ域蕗蜊灘・縺悟燕・・
                const isLocked = lockedSeats.some(ls => ls.row === r && ls.col === c);
                if (!isLocked) {
                    availablePositions.push({ r, c });
                }
            }
        }

        // 逡ｪ蜿ｷ鬆・↓驟咲ｽｮ
        let studentIndex = 0;
        availablePositions.forEach(pos => {
            if (studentIndex < studentsToArrange.length) {
                this.currentLayout[pos.r][pos.c] = studentsToArrange[studentIndex].id;
                studentIndex++;
            } else {
                this.currentLayout[pos.r][pos.c] = null;
            }
        });

        this.saveCurrentLayout();
        this.render();
    },

    // 蠎ｧ蟶ｭ繧偵け繝ｪ繧｢
    clearSeating() {
        if (!confirm('縺吶∋縺ｦ縺ｮ蠎ｧ蟶ｭ繧偵け繝ｪ繧｢縺励∪縺吶°・・)) {
            return;
        }

        this.currentLayout = this.createEmptyLayout();
        this.saveCurrentLayout();
        this.render();
    },

    // 迴ｾ蝨ｨ縺ｮ繝ｬ繧､繧｢繧ｦ繝医ｒ菫晏ｭ・
    saveCurrentLayout() {
        const data = StorageManager.getCurrentData();
        data.seating.current = this.currentLayout;
        data.seating.rows = this.rows;
        data.seating.cols = this.cols;
        StorageManager.updateCurrentData(data);
    },

    // 螻･豁ｴ縺ｫ菫晏ｭ・
    saveToHistory() {
        const name = prompt('縺薙・驟咲ｽｮ縺ｫ蜷榊燕繧剃ｻ倥￠縺ｦ縺上□縺輔＞・井ｾ・ 2蟄ｦ譛溷ｸｭ譖ｿ縺茨ｼ・);
        if (!name) return;

        const data = StorageManager.getCurrentData();

        if (!data.seating.history) {
            data.seating.history = [];
        }

        data.seating.history.unshift({
            name: name,
            timestamp: new Date().toISOString(),
            layout: JSON.parse(JSON.stringify(this.currentLayout)),
            rows: this.rows,
            cols: this.cols
        });

        // 譛螟ｧ10莉ｶ縺ｾ縺ｧ菫晄戟
        data.seating.history = data.seating.history.slice(0, 10);

        StorageManager.updateCurrentData(data);
        alert('螻･豁ｴ縺ｫ菫晏ｭ倥＠縺ｾ縺励◆');
    },

    // 螻･豁ｴ繧定｡ｨ遉ｺ
    showHistory() {
        const data = StorageManager.getCurrentData();
        const history = data.seating.history || [];

        if (history.length === 0) {
            alert('螻･豁ｴ縺後≠繧翫∪縺帙ｓ');
            return;
        }

        const modal = document.getElementById('seatingHistoryModal');
        const container = document.getElementById('seatingHistoryList');

        container.innerHTML = history.map((item, index) => `
            <div class="history-item">
                <div class="history-info">
                    <div class="history-name">${item.name}</div>
                    <div class="history-time">${new Date(item.timestamp).toLocaleString('ja-JP')}</div>
                    <div class="history-size">${item.rows}陦・ﾃ・${item.cols}蛻・/div>
                </div>
                <div class="history-actions">
                    <button class="btn btn-primary" onclick="SeatingModule.loadFromHistory(${index})">隱ｭ縺ｿ霎ｼ縺ｿ</button>
                    <button class="btn-icon delete" onclick="SeatingModule.deleteFromHistory(${index})">卵・・/button>
                </div>
            </div>
        `).join('');

        modal.classList.add('active');
    },

    // 螻･豁ｴ縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ
    loadFromHistory(index) {
        const data = StorageManager.getCurrentData();
        const history = data.seating.history || [];

        if (index >= history.length) return;

        const item = history[index];

        if (confirm(`縲・{item.name}縲阪・驟咲ｽｮ繧定ｪｭ縺ｿ霎ｼ縺ｿ縺ｾ縺吶°・歃n迴ｾ蝨ｨ縺ｮ驟咲ｽｮ縺ｯ荳頑嶌縺阪＆繧後∪縺吶Ａ)) {
            this.currentLayout = JSON.parse(JSON.stringify(item.layout));
            this.rows = item.rows;
            this.cols = item.cols;
            this.saveCurrentLayout();
            this.closeHistoryModal();
            this.render();
        }
    },

    // 螻･豁ｴ縺九ｉ蜑企勁
    deleteFromHistory(index) {
        const data = StorageManager.getCurrentData();
        const history = data.seating.history || [];

        if (index >= history.length) return;

        if (confirm('縺薙・螻･豁ｴ繧貞炎髯､縺励∪縺吶°・・)) {
            history.splice(index, 1);
            data.seating.history = history;
            StorageManager.updateCurrentData(data);
            this.showHistory(); // 蜀崎｡ｨ遉ｺ
        }
    },

    // 螻･豁ｴ繝｢繝ｼ繝繝ｫ繧帝哩縺倥ｋ
    closeHistoryModal() {
        const modal = document.getElementById('seatingHistoryModal');
        modal.classList.remove('active');
    },

    // 蟶ｭ驟咲ｽｮ蝗ｳ縺ｮ蜊ｰ蛻ｷ・医￥縺伜ｯｾ蠢懶ｼ・
    printSeating() {
        const data = StorageManager.getCurrentData();
        const layout = this.currentLayout;
        const lotteryData = data.seating.lotteryData || {};
        const lotteryType = data.seating.lotteryType || 'cards';
        const cardsCount = data.seating.cardsCount || { spade: 10, club: 10, heart: 10, diamond: 10 };
        const numberStart = data.seating.numberStart || 1;
        const numberEnd = data.seating.numberEnd || 40;

        // 縺ｾ縺壹・蠎ｧ蟶ｭ驟咲ｽｮ陦ｨ・育函蠕貞錐蜈･繧奇ｼ・
        let seatRows = '';
        for (let r = 0; r < this.rows; r++) {
            let cols = '';
            for (let c = 0; c < this.cols; c++) {
                const studentId = layout[r][c];
                const item = lotteryData[`${r}-${c}`]; // lotteryData縺九ｉ蜿門ｾ・

                let content = '';
                if (studentId) {
                    const student = data.students.find(s => s.id === studentId);
                    if (student) {
                        // 譁・ｭ励し繧､繧ｺ隱ｿ謨ｴ
                        const fontSize = (student.nameKanji.length > 4) ? '12px' : '16px';
                        content = `<div class="seat-kana">${student.nameKana || ''}</div><div class="seat-name" style="font-size:${fontSize}">${student.nameKanji}</div>`;
                    }
                } else {
                    content = '<div class="seat-name">遨ｺ蟶ｭ</div>';
                }

                // 縺上§諠・ｱ縺ｮ莉倩ｨ・
                let lotteryInfo = '';
                if (item) {
                    // 繧ｫ繝ｼ繝画ュ蝣ｱ
                    if (item.type === 'card' || (!item.type && item.suit)) {
                        const suit = this.suits.find(s => s.id === item.suit);
                        lotteryInfo = `<div class="seat-lottery ${suit.color}">${suit.symbol}${item.number}</div>`;
                    } else if (item.type === 'number') {
                        lotteryInfo = `<div class="seat-lottery">No.${item.value}</div>`;
                    }
                }

                cols += `<td class="seat-cell">${lotteryInfo}${content}</td>`;
            }
            seatRows += `<tr>${cols}</tr>`;
        }

        const teacherDesk = `
            <div style="text-align: center; margin: 20px 0; border: 2px solid #000; padding: 10px; width: 200px; margin-left: auto; margin-right: auto; font-weight: bold;">
                謨吝酷
            </div>
        `;

        // 縺上§蠑輔″險伜・谺・函謌・
        let lotteryListHtml = '';
        if (lotteryType === 'cards') {
            const suitCols = this.suits.map(suit => {
                const max = cardsCount[suit.id] || 0;
                let rows = '';
                for (let i = 1; i <= max; i++) {
                    // 縺昴・繧ｫ繝ｼ繝峨ｒ蠑輔＞縺溽函蠕偵ｒ謗｢縺・
                    const studentId = this.findStudentIdByLotteryItem('card', suit.id, i);
                    let name = '';
                    if (studentId) {
                        const student = data.students.find(s => s.id === studentId);
                        if (student) name = student.nameKanji;
                    }

                    rows += `
                        <div class="lottery-item">
                            <span class="lottery-label ${suit.color}">${suit.symbol}${i}</span>
                            <span class="lottery-name">${name}</span>
                        </div>
                    `;
                }
                return `
                    <div class="lottery-col">
                        <div class="lottery-header ${suit.color}">${suit.symbol} ${suit.label}</div>
                        ${rows}
                    </div>
                `;
            }).join('');

            lotteryListHtml = `<div class="lottery-list-container">${suitCols}</div>`;

        } else {
            // 逡ｪ蜿ｷ縺上§逕ｨ繝ｪ繧ｹ繝茨ｼ医す繝ｳ繝励Ν騾｣逡ｪ・・
            let items = '';
            for (let i = numberStart; i <= numberEnd; i++) {
                const studentId = this.findStudentIdByLotteryItem('number', null, i);
                let name = '';
                if (studentId) {
                    const student = data.students.find(s => s.id === studentId);
                    if (student) name = student.nameKanji;
                }

                items += `
                    <div class="lottery-item num-item">
                         <span class="lottery-label">No.${i}</span>
                         <span class="lottery-name">${name}</span>
                    </div>
                `;
            }
            lotteryListHtml = `<div class="lottery-list-container type-number">${items}</div>`;
        }

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>蟶ｭ驟咲ｽｮ蝗ｳ</title>
                <style>
                    body { font-family: "Meiryo", "Hiragino Kaku Gothic ProN", sans-serif; padding: 20px; }
                    h1 { text-align: center; }
                    .date { text-align: right; margin-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; }
                    td { border: 1px solid #000; padding: 5px; text-align: center; height: 80px; vertical-align: middle; position: relative; }
                    .seat-name { font-weight: bold; }
                    .seat-kana { font-size: 10px; color: #555; margin-bottom: 2px; }
                    .seat-lottery { position: absolute; top: 2px; left: 2px; font-size: 10px; font-weight: bold; border: 1px solid #ddd; padding: 0 3px; border-radius: 3px; }
                    .red { color: red; }
                    .black { color: black; }
                    
                    .lottery-section { margin-top: 40px; page-break-before: always; }
                    .lottery-list-container { display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
                    .lottery-col { flex: 1; border: 1px solid #000; }
                    .lottery-header { text-align: center; font-weight: bold; border-bottom: 1px solid #000; padding: 5px; background: #eee; }
                    .lottery-item { display: flex; border-bottom: 1px solid #ccc; font-size: 12px; }
                    .lottery-item:last-child { border-bottom: none; }
                    .lottery-label { width: 40px; border-right: 1px solid #ccc; padding: 5px; text-align: center; font-weight: bold; display: flex; align-items: center; justify-content: center; }
                    .lottery-name { flex: 1; padding: 5px; }
                    
                    /* 逡ｪ蜿ｷ縺上§逕ｨ */
                    .type-number { display: block; column-count: 4; column-gap: 20px; }
                    .type-number .lottery-item { border: 1px solid #ccc; margin-bottom: 5px; break-inside: avoid; }
                    .num-item .lottery-label { width: 50px; background: #f0f0f0; }

                    @media print {
                        .no-print { display: none; }
                        body { padding: 0; }
                    }
                </style>
            </head>
            <body>
                <h1>蟶ｭ驟咲ｽｮ蝗ｳ</h1>
                <div class="date">${new Date().toLocaleDateString('ja-JP')}</div>
                ${teacherDesk}
                <table>${seatRows}</table>
                
                <div class="lottery-section">
                    <h1>縺上§蠑輔″險伜・陦ｨ</h1>
                    ${lotteryListHtml}
                </div>
            </body>
            </html>
        `);
        printWindow.document.close();
    },

    // 縺上§蠑輔″險ｭ螳壹・謫堺ｽ懊ヱ繝阪Ν謠冗判
    renderLotteryControls() {
        let controls = document.getElementById('lotteryControlsPanel');
        if (!controls) {
            const parent = document.getElementById('seatingGrid')?.parentNode;
            if (parent) {
                controls = document.createElement('div');
                controls.id = 'lotteryControlsPanel';
                controls.className = 'lottery-settings-panel';
                controls.style.marginBottom = '20px';
                controls.style.padding = '15px';
                controls.style.background = '#f7fafc';
                controls.style.border = '1px solid #e2e8f0';
                controls.style.borderRadius = '8px';
                parent.insertBefore(controls, document.getElementById('seatingGrid'));
            }
        }

        if (!controls) return;

        const lotteryType = this.lotteryType || 'cards'; // 'cards' or 'numbers'

        // 繝槭・繧ｯ縺斐→縺ｮ譫壽焚險ｭ螳夲ｼ医ョ繝輔か繝ｫ繝医・蜈ｨ縺ｦ10譫夲ｼ・
        const cardsCount = this.cardsCount || {
            spade: 10, club: 10, heart: 10, diamond: 10
        };

        const numberStart = this.numberStart || 1;
        const numberEnd = this.numberEnd || 40;

        let settingsHtml = '';
        if (lotteryType === 'cards') {
            settingsHtml = `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: bold;">蜷・・繝ｼ繧ｯ縺ｮ譫壽焚:</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                        ${this.suits.map(suit => `
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span class="${suit.color}" style="font-size: 1.2em;">${suit.symbol}</span>
                                <input type="number" class="suit-count-input" data-suit="${suit.id}" value="${cardsCount[suit.id] || 10}" min="0" max="13" style="width: 50px; padding: 4px;">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else {
            settingsHtml = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="font-weight: bold;">逡ｪ蜿ｷ遽・峇:</label>
                    <input type="number" id="lotteryNumberStart" value="${numberStart}" min="1" style="width: 60px; padding: 5px;">
                    <span>縲・/span>
                    <input type="number" id="lotteryNumberEnd" value="${numberEnd}" min="1" style="width: 60px; padding: 5px;">
                    <span>逡ｪ</span>
                </div>
            `;
        }

        controls.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">
                    <label style="font-weight: bold;">縺上§繧ｿ繧､繝・</label>
                    <label style="cursor: pointer;">
                        <input type="radio" name="lotteryType" value="cards" ${lotteryType === 'cards' ? 'checked' : ''}> 笙 繝医Λ繝ｳ繝・
                    </label>
                    <label style="cursor: pointer;">
                        <input type="radio" name="lotteryType" value="numbers" ${lotteryType === 'numbers' ? 'checked' : ''}> 箸 逡ｪ蜿ｷ縺上§
                    </label>
                </div>
                
                <div id="lotterySettingsArea">
                    ${settingsHtml}
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="lotteryReshuffleBtn" class="btn btn-warning">蜀埼・鄂ｮ・医す繝｣繝・ヵ繝ｫ・・/button>
                    <button id="lotteryInputBtn" class="btn btn-primary">邨先棡蜈･蜉・/button>
                    <button id="lotteryPrintBtn" class="btn btn-secondary">蟶ｭ繝ｻ縺上§驟咲ｽｮ蝗ｳ繧貞魂蛻ｷ</button>
                </div>
                
                <div style="font-size: 0.9em; color: #666;">
                    窶ｻ縲悟・驟咲ｽｮ縲阪ｒ謚ｼ縺吶→縲√Ο繝・け・芋沐抵ｼ峨＆繧後※縺・↑縺・ｺｧ蟶ｭ縺ｮ縺上§縺後す繝｣繝・ヵ繝ｫ縺輔ｌ縺ｾ縺吶・br>
                    窶ｻ 縺上§繧ｿ繧､繝励ｒ螟画峩縺励※蜀埼・鄂ｮ縺吶ｋ縺ｨ縲∝・蜉帶ｸ医∩縺ｮ邨先棡縺ｯ繝ｪ繧ｻ繝・ヨ縺輔ｌ縺ｾ縺吶・
                </div>
            </div>
        `;

        // 繧､繝吶Φ繝郁ｨｭ螳・
        controls.querySelectorAll('input[name="lotteryType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.lotteryType = e.target.value;
                this.renderLotteryControls(); // 險ｭ螳壹お繝ｪ繧｢繧呈峩譁ｰ
            });
        });

        if (lotteryType === 'cards') {
            controls.querySelectorAll('.suit-count-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    if (!this.cardsCount) this.cardsCount = {};
                    this.cardsCount[e.target.dataset.suit] = parseInt(e.target.value) || 0;
                });
            });
        } else {
            controls.querySelector('#lotteryNumberStart').addEventListener('change', (e) => {
                this.numberStart = parseInt(e.target.value) || 1;
            });
            controls.querySelector('#lotteryNumberEnd').addEventListener('change', (e) => {
                this.numberEnd = parseInt(e.target.value) || 40;
            });
        }

        controls.querySelector('#lotteryReshuffleBtn').addEventListener('click', () => {
            const msg = this.isLotteryStarted ?
                '迴ｾ蝨ｨ縺ｮ驟咲ｽｮ縺ｨ蜈･蜉帷ｵ先棡・医ｂ縺励≠繧後・・峨・繝ｪ繧ｻ繝・ヨ縺輔ｌ縲∵眠縺励￥縺上§縺碁・鄂ｮ縺輔ｌ縺ｾ縺吶・n繝ｭ繝・け縺輔ｌ縺溷ｺｧ蟶ｭ縺ｯ邯ｭ謖√＆繧後∪縺吶・n繧医ｍ縺励＞縺ｧ縺吶°・・ :
                '譁ｰ縺励￥縺上§繧帝・鄂ｮ縺励∪縺吶ゅｈ繧阪＠縺・〒縺吶°・・;

            if (confirm(msg)) {
                this.setupLottery();
            }
        });

        controls.querySelector('#lotteryInputBtn').addEventListener('click', () => {
            this.openLotteryInputModal();
        });

        controls.querySelector('#lotteryPrintBtn').addEventListener('click', () => {
            this.printSeating();
        });
    },

    // 縺上§蠑輔″繝｢繝ｼ繝牙・繧頑崛縺・
    toggleLotteryMode() {
        this.isLotteryMode = !this.isLotteryMode;

        // 繝・ヵ繧ｩ繝ｫ繝郁ｨｭ螳・
        if (!this.lotteryType) this.lotteryType = 'cards';
        if (!this.cardsCount) {
            this.cardsCount = { spade: 10, club: 10, heart: 10, diamond: 10 };
        }
        if (!this.numberStart) this.numberStart = 1;
        if (!this.numberEnd) this.numberEnd = 40;

        const btn = document.getElementById('toggleLotteryBtn');
        const rowsInput = document.getElementById('seatingRows');
        const colsInput = document.getElementById('seatingCols');
        const seatingControls = document.querySelector('.seating-controls');
        const panel = document.getElementById('lotteryControlsPanel');

        if (this.isLotteryMode) {
            if (btn) {
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-secondary');
            }
            if (rowsInput) rowsInput.disabled = true;
            if (colsInput) colsInput.disabled = true;
            if (seatingControls) seatingControls.style.opacity = '0.5';

            const data = StorageManager.getCurrentData();
            // 譌｢縺ｫ繝・・繧ｿ縺後≠繧後・繝ｭ繝ｼ繝・
            if (!data.seating.lotteryData) {
                this.isLotteryStarted = false;
            } else {
                this.isLotteryStarted = true;
                // 菫晏ｭ倥＆繧後◆險ｭ螳壹ｒ繝ｭ繝ｼ繝・
                this.lotteryType = data.seating.lotteryType || 'cards';
                this.cardsCount = data.seating.cardsCount || { spade: 10, club: 10, heart: 10, diamond: 10 };
                // 譌ｧ繝・・繧ｿ蟇ｾ蠢・
                if (data.seating.cardsPerSuit && !data.seating.cardsCount) {
                    const count = data.seating.cardsPerSuit;
                    this.cardsCount = { spade: count, club: count, heart: count, diamond: count };
                }

                this.numberStart = data.seating.numberStart || 1;
                this.numberEnd = data.seating.numberEnd || 40;
            }
            this.render();
        } else {
            if (btn) {
                btn.classList.add('btn-secondary');
                btn.classList.remove('btn-primary');
            }
            if (panel) panel.remove();
            if (rowsInput) rowsInput.disabled = false;
            if (colsInput) colsInput.disabled = false;
            if (seatingControls) seatingControls.style.opacity = '1';
            this.render();
        }
    },

    // 縺上§縺ｮ繧ｻ繝・ヨ繧｢繝・・・医す繝｣繝・ヵ繝ｫ繝ｻ驟咲ｽｮ・・
    setupLottery() {
        const data = StorageManager.getCurrentData();
        const lockedSeats = data.seating.lockedSeats || [];

        const availablePositions = [];
        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                const isLocked = lockedSeats.some(ls => ls.row === r && ls.col === c);
                if (!isLocked) {
                    availablePositions.push({ r, c });
                }
            }
        }

        if (availablePositions.length === 0) {
            alert('驟咲ｽｮ蜿ｯ閭ｽ縺ｪ蠎ｧ蟶ｭ縺後≠繧翫∪縺帙ｓ');
            return;
        }

        // 謚ｽ驕ｸ蟇ｾ雎｡縺ｮ逕滓・
        const deck = [];
        if (this.lotteryType === 'cards') {
            const counts = this.cardsCount || { spade: 10, club: 10, heart: 10, diamond: 10 };
            this.suits.forEach(suit => {
                const max = counts[suit.id] || 0;
                for (let i = 1; i <= max; i++) {
                    deck.push({ type: 'card', suit: suit.id, number: i });
                }
            });
        } else {
            // 逡ｪ蜿ｷ縺上§
            for (let i = this.numberStart; i <= this.numberEnd; i++) {
                deck.push({ type: 'number', value: i });
            }
        }

        // 繧ｷ繝｣繝・ヵ繝ｫ
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }

        const lotteryData = {}; // { 'row-col': { type: 'card'|'number', ... } }

        availablePositions.forEach((pos, index) => {
            if (index < deck.length) {
                lotteryData[`${pos.r}-${pos.c}`] = deck[index];
            }
        });

        // 繝・・繧ｿ縺ｮ菫晏ｭ・
        if (!data.seating) data.seating = {};
        data.seating.lotteryData = lotteryData;

        data.seating.lotteryType = this.lotteryType;
        data.seating.cardsCount = this.cardsCount;
        data.seating.numberStart = this.numberStart;
        data.seating.numberEnd = this.numberEnd;

        // 譌ｧ繝・・繧ｿ莠呈鋤諤ｧ縺ｮ縺溘ａ・亥ｿｵ縺ｮ縺溘ａ繧ｯ繝ｪ繧｢・・
        delete data.seating.cards;
        delete data.seating.cardsPerSuit; // 譌ｧ荳諡ｬ險ｭ螳・

        StorageManager.updateCurrentData(data);
        this.isLotteryStarted = true;
        this.render();
    },

    // 縺上§蠑輔″繧ｰ繝ｪ繝・ラ謠冗判
    renderLotteryGrid() {
        const container = document.getElementById('seatingGrid');
        if (!container) return;

        const data = StorageManager.getCurrentData();
        const lotteryData = data.seating.lotteryData || {};
        // 譌ｧ繝・・繧ｿ繧ｵ繝昴・繝・
        if (!lotteryData && data.seating.cards) {
            // 閾ｪ蜍慕ｧｻ陦後・隍・尅縺ｪ縺ｮ縺ｧ縲√Μ繧ｻ繝・ヨ繧剃ｿ・☆UI縺ｫ縺吶ｋ縺九√≠繧九＞縺ｯ縺薙％縺ｧ隱ｭ縺ｿ譖ｿ縺医ｋ
            // 莉雁屓縺ｯsetupLottery縺ｧ荳頑嶌縺阪＆繧後ｋ蜑肴署
        }

        const lockedSeats = data.seating.lockedSeats || [];
        const lockedCards = data.seating.lockedCards || [];

        container.innerHTML = '';
        container.style.gridTemplateColumns = `repeat(${this.cols}, 1fr)`;

        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.dataset.row = r;
                seat.dataset.col = c;

                const isLocked = lockedSeats.some(s => s.row === r && s.col === c);
                const isCardLocked = lockedCards.some(lc => lc.row === r && lc.col === c);
                if (isLocked) seat.classList.add('locked');
                if (isCardLocked) seat.classList.add('card-locked');

                const item = lotteryData[`${r}-${c}`];

                if (item) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'seat-card';
                    itemDiv.draggable = !isCardLocked;

                    if (item.type === 'card' || (!item.type && item.suit)) { // 譌ｧ繝・・繧ｿ莠呈鋤
                        // 繝医Λ繝ｳ繝・
                        const suitId = item.suit;
                        const suitInfo = this.suits.find(s => s.id === suitId) || this.suits[0];
                        itemDiv.innerHTML = `
                            <div class="card-suit ${suitInfo.color}">${suitInfo.symbol}</div>
                            <div class="card-number ${suitInfo.color}">${item.number}</div>
                        `;
                    } else if (item.type === 'number') {
                        // 逡ｪ蜿ｷ縺上§
                        itemDiv.innerHTML = `
                             <div class="ticket-icon">辞</div>
                             <div class="ticket-number">${item.value}</div>
                        `;
                    }

                    // 繝ｭ繝・け繝懊ち繝ｳ
                    const lockBtn = document.createElement('button');
                    lockBtn.className = `card-lock-btn ${isCardLocked ? 'active' : ''}`;
                    lockBtn.innerHTML = isCardLocked ? '白' : '箔';
                    lockBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.toggleCardLock(r, c);
                    };
                    itemDiv.appendChild(lockBtn);

                    // 繝峨Λ繝・げ
                    if (!isCardLocked) {
                        itemDiv.addEventListener('dragstart', (e) => {
                            this.draggedCard = { row: r, col: c, item: item };
                            e.dataTransfer.effectAllowed = 'move';
                            seat.classList.add('dragging');
                        });
                        itemDiv.addEventListener('dragend', () => {
                            seat.classList.remove('dragging');
                            this.draggedCard = null;
                        });
                    }

                    seat.appendChild(itemDiv);
                } else {
                    // 遨ｺ蟶ｭ/譛ｪ驟咲ｽｮ
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'seat-empty-card';

                    if (isLocked) {
                        const studentId = this.currentLayout[r] && this.currentLayout[r][c];
                        if (studentId) {
                            const student = data.students.find(s => s.id === studentId);
                            emptyDiv.innerHTML = `<div>${student ? student.nameKanji : '遨ｺ蟶ｭ'}</div><div style="font-size:0.7em">(蝗ｺ螳・</div>`;
                        } else {
                            emptyDiv.innerHTML = '<div>(蝗ｺ螳・</div>';
                        }
                    } else {
                        emptyDiv.innerHTML = '<div class="seat-empty">遨ｺ蟶ｭ</div>';
                    }

                    // 繝ｭ繝・け繝懊ち繝ｳ
                    const lockBtn = document.createElement('button');
                    lockBtn.className = `card-lock-btn ${isCardLocked ? 'active' : ''}`;
                    lockBtn.innerHTML = isCardLocked ? '白' : '箔';
                    lockBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.toggleCardLock(r, c);
                    };
                    emptyDiv.appendChild(lockBtn);

                    seat.appendChild(emptyDiv);
                }

                // 繝峨Ο繝・・
                seat.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (this.draggedCard && !isCardLocked) {
                        seat.classList.add('drag-over');
                    }
                });
                seat.addEventListener('dragleave', () => {
                    seat.classList.remove('drag-over');
                });
                seat.addEventListener('drop', (e) => {
                    e.preventDefault();
                    seat.classList.remove('drag-over');
                    if (this.draggedCard && !isCardLocked) {
                        this.swapCards(this.draggedCard.row, this.draggedCard.col, r, c);
                    }
                });

                container.appendChild(seat);
            }
        }
        this.renderTeacherDesk();
    },

    // 繧ｫ繝ｼ繝峨Ο繝・け蛻・ｊ譖ｿ縺茨ｼ域里蟄倥→蜷後§縺ｧ繧医＞縺悟ｿｵ縺ｮ縺溘ａ蜀肴軸・・
    toggleCardLock(row, col) {
        const data = StorageManager.getCurrentData();
        if (!data.seating.lockedCards) data.seating.lockedCards = [];
        const index = data.seating.lockedCards.findIndex(lc => lc.row === row && lc.col === col);
        if (index > -1) {
            data.seating.lockedCards.splice(index, 1);
        } else {
            data.seating.lockedCards.push({ row, col });
        }
        StorageManager.updateCurrentData(data);
        this.render();
    },

    // 繧ｫ繝ｼ繝牙・繧梧崛縺茨ｼ域ｱ守畑蛹厄ｼ・
    swapCards(fromRow, fromCol, toRow, toCol) {
        const data = StorageManager.getCurrentData();
        const lotteryData = data.seating.lotteryData || {};

        const fromKey = `${fromRow}-${fromCol}`;
        const toKey = `${toRow}-${toCol}`;

        const fromItem = lotteryData[fromKey];
        const toItem = lotteryData[toKey];

        if (fromItem) lotteryData[toKey] = fromItem;
        else delete lotteryData[toKey];

        if (toItem) lotteryData[fromKey] = toItem;
        else delete lotteryData[fromKey];

        data.seating.lotteryData = lotteryData;
        StorageManager.updateCurrentData(data);
        this.render();
    },

    // 邨先棡蜈･蜉帙Δ繝ｼ繝繝ｫ繧帝幕縺擾ｼ医・繝ｼ繧ｯ蛻･繝ｪ繧ｹ繝亥ｽ｢蠑擾ｼ夂ｸｦ譁ｹ蜷托ｼ・
    openLotteryInputModal() {
        const grid = document.getElementById('lotteryInputGrid');
        grid.innerHTML = '';

        // 繝｢繝ｼ繝繝ｫ縺ｮ繧ｹ繧ｿ繧､繝ｫ隱ｿ謨ｴ・亥ｹ・ｒ蠎・￡繧具ｼ・
        const modalContent = document.querySelector('#lotteryInputModal .modal-content');
        if (modalContent) {
            modalContent.style.maxWidth = '95vw';
            modalContent.style.width = '1200px';
        }

        const type = this.lotteryType || 'cards';

        if (type === 'cards') {
            grid.style.display = 'flex';
            grid.style.flexWrap = 'nowrap';
            grid.style.gap = '15px';
            grid.style.justifyContent = 'space-between';
            grid.style.overflowX = 'auto'; // 讓ｪ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ險ｱ蜿ｯ

            // 荳譎ゆｿ晏ｭ倡畑繝・・繧ｿ繧貞・譛溷喧
            this.tempLotteryInput = {};

            const counts = this.cardsCount || { spade: 10, club: 10, heart: 10, diamond: 10 };

            this.suits.forEach(suit => {
                const maxNum = counts[suit.id] || 0;
                if (maxNum === 0) return; // 0譫壹↑繧芽｡ｨ遉ｺ縺励↑縺・

                const col = document.createElement('div');
                col.style.flex = '1';
                col.style.minWidth = '250px'; // 譛菴主ｹ・｢ｺ菫・
                col.style.border = '1px solid #ccc';
                col.style.background = '#f9f9f9';

                const header = document.createElement('div');
                header.innerHTML = `${suit.symbol} ${suit.label}`;
                header.className = suit.color;
                header.style.textAlign = 'center';
                header.style.fontWeight = 'bold';
                header.style.padding = '8px';
                header.style.borderBottom = '1px solid #ccc';
                header.style.background = '#eaeaea';
                col.appendChild(header);

                for (let i = 1; i <= maxNum; i++) {
                    const row = this._createLotteryInputRow(suit.id, i, 'card');
                    col.appendChild(row);
                }
                grid.appendChild(col);
            });
        } else {
            // 逡ｪ蜿ｷ縺上§・医す繝ｳ繝励Ν繧ｰ繝ｪ繝・ラ・・
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
            grid.style.gap = '10px';
            grid.style.overflowY = 'auto';
            grid.style.maxHeight = '70vh';

            this.tempLotteryInput = {};

            const start = this.numberStart || 1;
            const end = this.numberEnd || 40;

            for (let i = start; i <= end; i++) {
                const row = this._createLotteryInputRow(null, i, 'number');
                // 繧ｰ繝ｪ繝・ラ縺ｫ驕ｩ縺励◆繧ｹ繧ｿ繧､繝ｫ隱ｿ謨ｴ
                row.style.border = '1px solid #ddd';
                row.style.background = '#fff';
                row.style.borderRadius = '4px';
                grid.appendChild(row);
            }
        }

        document.getElementById('lotteryInputModal').classList.add('active');
        // 譛蛻昴・蜈･蜉帶ｬ・↓繝輔か繝ｼ繧ｫ繧ｹ
        setTimeout(() => grid.querySelector('input')?.focus(), 100);
    },

    // 蜈･蜉幄｡檎函謌舌・繝ｫ繝代・
    _createLotteryInputRow(suitId, number, type) {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.padding = '4px 8px';
        if (type === 'card') row.style.borderBottom = '1px solid #eee';

        const labelDiv = document.createElement('div');
        if (type === 'card') {
            labelDiv.textContent = number;
        } else {
            labelDiv.innerHTML = `<span style="font-size:0.8em">No.</span><b>${number}</b>`;
        }
        labelDiv.style.width = '40px';
        labelDiv.style.fontWeight = 'bold';
        labelDiv.style.textAlign = 'center';
        row.appendChild(labelDiv);

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'student-input';

        // 隴伜挨逕ｨ繧ｭ繝ｼ
        const key = type === 'card' ? `${suitId}-${number}` : `number-${number}`;

        input.dataset.key = key;
        input.placeholder = '逡ｪ蜿ｷ';
        input.maxLength = 4;
        input.style.width = '60px'; // 逡ｪ蜿ｷ縺ｮ縺ｿ蜈･蜉・
        input.style.padding = '4px';
        input.style.textAlign = 'center';

        // 譌｢蟄伜､縺ｮ讀懃ｴ｢
        const currentStudentId = this.findStudentIdByLotteryItem(type, suitId, number);
        if (currentStudentId) {
            const student = this.getStudentById(currentStudentId);
            if (student) input.value = student.number;
        }

        // 蜷榊燕陦ｨ遉ｺ繧ｨ繝ｪ繧｢
        const nameDisplay = document.createElement('div');
        nameDisplay.className = 'name-display';
        nameDisplay.style.marginLeft = '8px';
        nameDisplay.style.fontSize = '0.85em';
        nameDisplay.style.color = '#666';
        nameDisplay.style.whiteSpace = 'nowrap';
        nameDisplay.style.overflow = 'hidden';
        nameDisplay.style.textOverflow = 'ellipsis';
        nameDisplay.style.maxWidth = '120px'; // 縺ｯ縺ｿ蜃ｺ縺鈴亟豁｢

        if (currentStudentId) {
            const student = this.getStudentById(currentStudentId);
            if (student) nameDisplay.textContent = student.nameKanji;
        }

        // 繧､繝吶Φ繝・
        input.addEventListener('input', (e) => {
            this.updateLotterySeat(key, e.target.value, nameDisplay);
        });

        // Enter遘ｻ蜍・
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                // 谺｡縺ｮinput繧呈爾縺呻ｼ・OM鬆・ｼ・
                const inputs = Array.from(document.querySelectorAll('#lotteryInputGrid input'));
                const idx = inputs.indexOf(e.target);
                if (idx > -1 && idx < inputs.length - 1) {
                    inputs[idx + 1].focus();
                }
            }
        });

        row.appendChild(input);
        row.appendChild(nameDisplay);
        return row;
    },

    // 縺上§鬆・岼縺九ｉ逕溷ｾ棚D繧帝・ｼ輔″・域ｱ守畑・・
    findStudentIdByLotteryItem(type, suitId, number) {
        const data = StorageManager.getCurrentData();
        const lotteryData = data.seating.lotteryData || {};
        const layout = this.currentLayout || [];

        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                const item = lotteryData[`${r}-${c}`];
                if (item) {
                    let match = false;
                    if (type === 'card' && item.type === 'card' && item.suit === suitId && item.number === number) match = true;
                    // 譌ｧ繝・・繧ｿ蟇ｾ蠢・
                    if (type === 'card' && !item.type && item.suit === suitId && item.number === number) match = true;
                    if (type === 'number' && item.type === 'number' && item.value === number) match = true;

                    if (match) {
                        return layout[r] && layout[r][c];
                    }
                }
            }
        }
        return null;
    },

    // 縺上§邨先棡縺ｮ譖ｴ譁ｰ・域ｱ守畑・・
    updateLotterySeat(key, studentNumber, nameDisplayElement) {
        const data = StorageManager.getCurrentData();
        const students = data.students || [];
        const student = students.find(s => s.number == studentNumber); // 蝙句､画鋤險ｱ螳ｹ

        if (student) {
            nameDisplayElement.textContent = student.nameKanji;
            nameDisplayElement.style.color = '#333';

            // 荳譎ゆｿ晏ｭ假ｼ育｢ｺ螳壽凾縺ｫ菴ｿ逕ｨ・・
            this.tempLotteryInput[key] = student.id;
        } else {
            nameDisplayElement.textContent = studentNumber ? '隧ｲ蠖薙↑縺・ : '';
            nameDisplayElement.style.color = '#999';
            delete this.tempLotteryInput[key];
        }
    },

    // 蜈･蜉帷ｵ先棡繧堤｢ｺ螳壹＠縺ｦ蜿肴丐
    reflectLotteryResults() {
        const data = StorageManager.getCurrentData();
        const lotteryData = data.seating.lotteryData || {};

        const layout = this.currentLayout || [];
        // layout驟榊・蛻晄悄蛹厄ｼ亥ｿ・ｦ√↓蠢懊§縺ｦ・・
        for (let r = 0; r < this.rows; r++) {
            if (!layout[r]) layout[r] = new Array(this.cols).fill(null);
        }

        Object.keys(this.tempLotteryInput).forEach(key => {
            const studentId = this.tempLotteryInput[key];
            if (!studentId) return;

            // key縺九ｉ縺上§諠・ｱ繧貞ｾｩ蜈・
            let targetType, targetVal1, targetVal2;
            if (key.startsWith('number-')) {
                targetType = 'number';
                targetVal1 = parseInt(key.split('-')[1]);
            } else {
                targetType = 'card';
                targetVal1 = key.split('-')[0]; // suit
                targetVal2 = parseInt(key.split('-')[1]); // number
            }

            // 縺薙・縺上§縺碁・鄂ｮ縺輔ｌ縺ｦ縺・ｋ蠎ｧ蟶ｭ繧呈爾縺・
            for (let r = 0; r < this.rows; r++) {
                for (let c = 0; c < this.cols; c++) {
                    const item = lotteryData[`${r}-${c}`];
                    // 蠎ｧ蟶ｭ閾ｪ菴薙・繝ｭ繝・け遒ｺ隱搾ｼ育函蠕貞崋螳壹Ο繝・け・・
                    const isSeatLocked = (data.seating.lockedSeats || []).some(s => s.row === r && s.col === c);

                    if (item && !isSeatLocked) {
                        let match = false;
                        if (targetType === 'number' && item.type === 'number' && item.value === targetVal1) match = true;
                        if (targetType === 'card' && item.type === 'card' && item.suit === targetVal1 && item.number === targetVal2) match = true;
                        // 譌ｧ
                        if (targetType === 'card' && !item.type && item.suit === targetVal1 && item.number === targetVal2) match = true;

                        if (match) {
                            // 蜿､縺・ｴ謇縺ｫ縺・ｋ蜷後§逕溷ｾ偵ｒ蜑企勁・磯㍾隍・賜髯､・・
                            for (let rr = 0; rr < this.rows; rr++) {
                                for (let cc = 0; cc < this.cols; cc++) {
                                    if (layout[rr] && layout[rr][cc] === studentId) {
                                        const lockCheck = (data.seating.lockedSeats || []).some(s => s.row === rr && s.col === cc);
                                        if (!lockCheck) layout[rr][cc] = null;
                                    }
                                }
                            }

                            layout[r][c] = studentId;
                        }
                    }
                }
            }
        });

        this.currentLayout = layout;
        this.saveSeatingLayout();
        document.getElementById('lotteryInputModal').classList.remove('active');
        this.render(); // 蜀肴緒逕ｻ
        UI.showToast('縺上§蠑輔″邨先棡繧貞渚譏縺励∪縺励◆');
    },

},



window.SeatingModule = SeatingModule;
